# CS2 训练数据高精度采集包 (生产环境稳健版)

一键式 CS2 Demo 分析、录制、可视化工具。基于 Electron + Node.js + Python，实现完全自动化的训练数据采集流程。

---

## 📋 目录
- [环境配置](#-环境配置)
- [UI 使用指南](#-ui-使用指南)
- [工作流程](#-工作流程)
- [可视化工具](#-可视化工具)
- [常见问题](#-常见问题)

---

## 🔧 环境配置

### 必需组件

#### 1. Node.js
- **版本**: v18+ 或更高
- **用途**: 运行 cs-demo-manager CLI 和 Electron 界面
- **安装**: [https://nodejs.org/](https://nodejs.org/)

#### 2. Python 环境
- **版本**: Python 3.10+
- **推荐**: 使用 Conda 创建独立环境
- **必需包**:
  ```bash
  pip install opencv-python numpy
  ```
- **用途**: 运行可视化回放脚本 (`visualize_playback.py`)

#### 3. PostgreSQL 数据库
- **版本**: 12+
- **默认配置**:
  - Host: `127.0.0.1`
  - Port: `5432`
  - Database: `csdm`
  - User: `postgres`
  - Password: 在 UI 中配置
- **用途**: 存储 Demo 元数据和训练窗口数据

#### 4. HLAE (Half-Life Advanced Effects)
- **版本**: 最新版
- **用途**: 录制 CS2 游戏视频
- **下载**: [https://www.advancedfx.org/](https://www.advancedfx.org/)
- **配置**: 自动通过 cs-demo-manager 调用

#### 5. FFmpeg
- **版本**: 最新 essentials build
- **用途**: 视频切片、帧提取
- **路径配置**: 默认 `F:\ffmpeg-xxx\bin\ffmpeg.exe`
- **修改位置**: `scripts/cli-generate-hlae-video.mjs:23`

#### 6. cs-demo-manager
- **用途**: 核心 Demo 分析引擎
- **位置**: `./cs-demo-manager/` 目录
- **依赖**: 自动通过 `npm install` 安装

### 初始化步骤

1. **安装依赖**
   ```bash
   npm install
   ```

2. **配置数据库密码**
   在 UI 界面右上角 "数据库密码" 输入框中输入 PostgreSQL 密码

3. **设置目录**
   - **Demo 总目录**: 存放所有 `.dem` 文件的根目录
   - **输出主目录**: 录制数据的输出目录

4. **安装 CS2 插件** (可选)
   ```bash
   node scripts/install-plugin.mjs
   ```

---

## 🖥️ UI 使用指南

### 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  [侧边栏]           │  [主界面]                         │
│  • Demo 文件列表    │  • 配置区域                       │
│  • 玩家进度显示     │  • 三大功能按钮                   │
│  • 刷新按钮         │  • 可视化工具                     │
│                     │  • 日志输出                       │
└─────────────────────────────────────────────────────────┘
```

### 侧边栏功能

#### 1. Demo 文件列表
- **✅ 全部文件**: 点击选中所有 Demo，进行批量操作
- **单个 Demo**: 点击选中单个文件
- **进度显示**:
  - `21/20` = 总回合数/已完成数
  - 🟢 绿色 = 全部完成
  - 🟠 橙色 = 部分完成
  - ⚪ 灰色 = 未完成

#### 2. 玩家信息交互
- **左键单击**: 复制 Steam ID 到剪贴板并自动填入输入框
- **右键单击**: 打开该 Demo 的输出文件夹

#### 3. 刷新进度按钮 (🔄)
- 重新扫描所有 Demo 的录制进度
- 自动检测：
  - `full_round.mp4` 是否存在
  - `frames/` 目录中的帧数 (支持 `.jpg` 和 `.png`)
  - `data.json` 是否完整

### 配置区域

#### 基本配置
| 配置项 | 说明 | 示例 |
|--------|------|------|
| **Demo 总目录** | 存放所有 .dem 文件的根目录 | `F:/cs/csdata/cs_raw_data/cs/demoall` |
| **输出主目录** | 录制数据的保存目录 | `F:/cs_data/traindata` |
| **回合号** | 指定录制的回合（留空=全部） | `1,2,3` 或留空 |
| **玩家 Steam ID** | 指定录制的玩家（留空=全部） | `76561199167176654` |
| **录制倍速** | HLAE 录制速度倍数 | `8` (推荐) |
| **每窗口帧数** | 每个训练窗口提取的帧数 | `10` (默认) |
| **数据库密码** | PostgreSQL 密码 | `your_password` |

#### 高级选项
- ☑️ **强制重新导出**: 覆盖已有数据，强制重新分析和录制

### 三大功能按钮

#### 1. 分析入库
```
功能: 分析 Demo 并提取训练窗口数据到数据库
流程:
  ├─ 解析 Demo 文件
  ├─ 提取玩家信息
  ├─ 识别关键事件
  └─ 写入 PostgreSQL
```
- **适用场景**: 首次处理 Demo
- **输出**: 数据库中的 `training_windows` 表
- **耗时**: 每个 Demo 约 10-30 秒

#### 2. 启动录制收割
```
功能: 启动 HLAE + CS2 录制训练数据
流程:
  ├─ 查询数据库中的训练窗口
  ├─ 逐个回合启动 HLAE 录制
  ├─ 使用 FFmpeg 切片视频
  ├─ 提取每窗口的关键帧
  └─ 生成 data.json 元数据
```
- **输出目录结构**:
  ```
  输出主目录/
  └── Demo名称/
      ├── 玩家名_SteamID_round1/
      │   ├── full_round.mp4        # 完整回合视频
      │   ├── frames/                # 提取的帧
      │   │   ├── frame_0000.jpg
      │   │   ├── frame_0001.jpg
      │   │   └── ...
      │   └── data.json              # 窗口元数据
      ├── 玩家名_SteamID_round2/
      └── ...
  ```
- **智能查重**:
  - 自动跳过已完成的回合
  - 检查 `data.json` 中的 `states: true` 标记
- **失败重试**: 每个回合最多重试 3 次

#### 3. 可视化 (配置)
- **功能**: 快速启动可视化工具，需先配置好参数
- **要求**: 必须指定单个 Demo、玩家 ID、回合号

### 可视化工具

#### 📁 选择文件夹播放
- **功能**: 直接播放指定的训练数据文件夹
- **用途**: 查看单个回合的录制结果
- **快捷键**:
  - `SPACE`: 暂停/继续
  - `右方向键` / `D`: 下一个窗口
  - `左方向键` / `A`: 上一个窗口
  - `ESC`: 退出
  - `T`: 标记为合格 (`review_status: "approved"`)
  - `E` / `F`: 标记为错误 (`review_status: "rejected"`)
  - `DELETE` / `Backspace`: 删除当前数据

#### 🎬 选择 Demo 浏览
- **功能**: 自动遍历指定 Demo 的所有训练数据文件夹
- **特性**:
  - 自动跳过已标记的文件夹（`review_status` 为 `"approved"` 或 `"rejected"`）
  - 支持前后切换
  - 支持删除、标记操作

### 日志区域

- **🗑️ 清除日志**: 清空日志输出
- **📋 复制日志**: 复制全部日志到剪贴板
- **⛔ 终止所有任务**: 强制终止所有后台进程（录制、分析等）

---

## 🔄 工作流程

### 智能分析机制 (重要！)

系统使用**双重分析策略**，自动优化性能和准确性：

#### 1. 快速扫描（自动触发）
**触发时机**：选中demo文件、刷新文件列表
```
选中demo → quick-scan-players → 使用 --list-players 参数
```
- ⚡ **极速响应**：只查询玩家信息，不分析训练窗口
- 📋 **显示玩家列表**：立即在侧边栏显示玩家信息
- 💾 **不写入training_windows**：不会生成训练数据
- ⏱️ **耗时**：每个demo约1-3秒

#### 2. 完整分析（手动触发）
**触发时机**：点击"分析入库"按钮
```
点击按钮 → start-analysis → 不使用 --list-players 参数
```
- 🔍 **深度分析**：完整解析demo，提取训练窗口
- 💾 **写入数据库**：生成training_windows表数据
- 🧠 **智能跳过**：已有完整数据的demo自动跳过
- 🔄 **自动清理**：training_windows为空的demo自动重新分析
- ⏱️ **耗时**：每个demo约10-30秒

#### 3. Fallback容错机制
**当数据库插入/查询失败时**：
```
Step 1-3: 分析 → 插入数据库 → ❌ 失败（CSV丢失/psql异步）
Step 4: 等待3秒
Step 5: 查询数据库 → ❌ 查询失败（5次重试）
Step 6: Fallback → 直接读取demo文件 → ✅ 获取tickrate
Step 7: 继续导出training_windows → ✅ 成功
```
- 🛡️ **容错保障**：即使psql CLI失败也能继续
- 📁 **直接读取**：从demo文件本身获取元数据
- ✅ **保证完成**：training_windows数据必定生成

### 完整流程示例

```
1. [准备] 将 .dem 文件放入 Demo 总目录
          ↓
2. [快速扫描] 选中demo → 自动显示玩家列表（1-3秒）
          ↓
3. [完整分析] 点击 "1. 分析入库" → 生成training_windows（10-30秒/demo）
          ↓ (智能跳过已有数据的demo，自动清理失败的demo)
4. [查看] 点击侧边栏玩家名，复制 Steam ID
          ↓
5. [录制] 点击 "2. 启动录制收割" 按钮
          ↓ (自动启动 HLAE + CS2，录制视频)
6. [审核] 使用 "🎬 选择Demo浏览" 查看结果
          ↓ (按 T 标记合格数据)
7. [完成] 标记的数据可用于 AI 训练
```

### 智能清理策略

系统会自动检测并清理有问题的数据：

#### 清理时机
- **点击"分析入库"按钮时**：自动检查所有demo的training_windows状态
- **不会清理**：已有完整training_windows数据的demo
- **自动清理**：training_windows为空的demo（说明之前分析失败）

#### 自动隔离损坏demo（新增）
- **自动检测**：一键全流程运行时，分析失败的demo会被自动识别
- **自动移动**：损坏的demo文件会自动移动到 `broken_demos/` 文件夹
- **智能跳过**：下次运行时自动跳过 `broken_demos/` 文件夹中的文件
- **日志提示**：移动时会显示 `🗂️ 已自动移动到: broken_demos/xxx.dem`

#### 清理操作
```sql
-- 对于 training_windows 为空的 demo：
DELETE FROM matches WHERE checksum = '...';  -- CASCADE自动删除关联数据
```
- ✅ 删除matches记录后，CLI会认为是新demo，自动重新分析
- ✅ 不需要手动勾选"强制重新导出"
- ✅ 有数据的demo完全不受影响

#### 日志输出示例
```
>>> 检查 training_windows 表...
  ✓ 所有 demo 数据完整          ← 所有demo都有数据
或
  ✓ 清理了 3 个未完成的 demo   ← 清理了3个失败的demo
>>> 开始智能分析...
[DEBUG] Is demo in database? true
[DEBUG] Force analyze? false      ← 不强制，智能判断
[DEBUG] Using cached data from database  ← 跳过已有数据的demo
```

### 批量处理技巧

#### 🚀 全流程批量处理（推荐）

**适用场景**：第一次处理大批量demo文件，从分析到录制一条龙

**操作步骤**：

1. **准备工作** (1分钟)
   ```
   ✓ 确认PostgreSQL数据库正在运行
   ✓ 确认所有demo文件已放入Demo总目录
   ✓ 确认输出主目录路径正确
   ✓ 确认数据库密码已填写
   ```

2. **批量分析** (预计时间：demo数量 × 15秒)
   ```
   → 点击侧边栏 "✅ 全部文件"
   → 点击 "1. 分析入库" 按钮
   → 等待所有demo分析完成
   ```
   **预期输出**：
   ```
   >>> 检查 training_windows 表...
     ✓ 清理了 X 个未完成的 demo
   >>> 开始智能分析...
   [1/50] 分析: demo1.dem
   [DEBUG] Is demo in database? false  ← 新demo，需要分析
   [DEBUG] Step 6: Fallback - reading demo file...
   [DEBUG] ✓ Export completed successfully!
   [2/50] 分析: demo2.dem
   [DEBUG] Is demo in database? true   ← 已有数据
   [DEBUG] Using cached data from database  ← 智能跳过
   ...
   ```

3. **检查数据库** (30秒)
   ```
   → 查看右侧"数据库状态"面板
   → 确认 training_windows 数量 > 0
   → 确认 demos 数量 = 你的demo文件数
   ```

4. **批量录制** (预计时间：demo数量 × 玩家数 × 回合数 × 2分钟)
   ```
   → 确保"✅ 全部文件"仍处于选中状态
   → 确保"玩家 Steam ID"输入框为空（录制所有玩家）
   → 确保"回合号"输入框为空（录制所有回合）
   → 点击 "2. 启动录制收割" 按钮
   → ⚠️ 不要关闭电脑，不要让电脑休眠！
   ```
   **自动化流程**：
   - ✅ CS2游戏会自动启动/关闭
   - ✅ HLAE会自动录制每个回合
   - ✅ FFmpeg会自动切片视频
   - ✅ 自动提取关键帧
   - ✅ 自动生成data.json
   - ✅ 已完成的回合自动跳过

5. **可视化审核** (可选，建议第二天进行)
   ```
   → 点击 "🎬 选择Demo浏览"
   → 使用快捷键审核：
     • T键：标记为合格（自动跳到下一个）
     • E/F键：标记为错误（重命名文件夹为false_xxx）
     • 右箭头：跳到下一个
   ```

**⏰ 时间估算示例**：
- 50个demo × 10玩家/demo × 20回合 × 2分钟/回合 = **约333小时** (14天)
- 建议：多台电脑并行处理，或先录制部分玩家

---

#### 场景 1: 批量分析所有 Demo
1. 点击侧边栏 "✅ 全部文件"
2. 点击 "1. 分析入库"
3. 等待批量处理完成

#### 场景 2: 只录制特定玩家
1. 选中单个 Demo
2. 点击玩家名复制 Steam ID（自动填入输入框）
3. 设置回合号（如 `1,2,3`）
4. 点击 "2. 启动录制收割"

#### 场景 3: 补录缺失的回合
1. 点击 "🔄 刷新进度" 查看完成情况
2. 查看未完成回合的 tooltip
3. 在 "回合号" 输入框填入缺失回合（如 `5,12,18`）
4. 点击 "2. 启动录制收割"

---

## 🎮 可视化工具详解

### 窗口显示信息

```
┌────────────────────────────────────────────────────────────┐
│  [游戏画面]          │  [信息面板]                         │
│                      │  • Data Path (JSON文件路径)         │
│                      │  • 窗口编号 / 总数                  │
│                      │  • 当前帧 / 总帧数                  │
│                      │  • Tick 范围                        │
│                      │  • 玩家状态 (血量、护甲、武器)      │
│                      │  • 位置坐标                         │
│                      │  • 局势描述                         │
│                      │  • 事件列表                         │
│                      │  [DELETE 按钮]                      │
└────────────────────────────────────────────────────────────┘
```

### 快捷键完整列表

| 按键 | 功能 | 说明 |
|------|------|------|
| `SPACE` | 暂停/继续 | 暂停播放以查看细节 |
| `→` / `D` | 下一个文件夹 | 切换到下一个回合数据 |
| `←` / `A` | 上一个文件夹 | 切换到上一个回合数据 |
| `ESC` | 退出 | 关闭可视化窗口 |
| `T` | 标记为合格 | 在 data.json 中写入 `review_status: "approved"` |
| `E` / `F` | 标记为错误 | 在 data.json 中写入 `review_status: "rejected"` |
| `DELETE` / `Backspace` | 删除数据 | 删除当前文件夹（需确认 Y/N） |

### 数据标记说明

**新格式**（推荐使用）：使用单个 `review_status` 字段

- **合格标记 (`review_status: "approved"`)**:
  - 🎬 浏览时自动跳过
  - 🎥 录制时自动跳过
  - ✅ 侧边栏进度统计中计入完成数
  - 💡 使用场景：人工审核后确认数据质量合格

- **错误标记 (`review_status: "rejected"`)**:
  - 🎬 浏览时自动跳过
  - 🎥 录制时自动跳过
  - ❌ 标记为不合格数据，便于后续分析和清理
  - 💡 使用场景：发现录制错误、数据异常、不符合训练要求的数据

- **未标记数据**:
  - `review_status` 字段不存在或为 `null`
  - 需要人工审核
  - 录制时会检查完整性但不会跳过

**向后兼容**：旧格式仍然支持
- `states: true` → 等同于 `review_status: "approved"`
- `error: true` → 等同于 `review_status: "rejected"`
- 按T或E键会自动转换为新格式并清理旧字段

---

## ❓ 常见问题

### Q1: 录制时 CS2 无法启动？
**A**: 检查以下几点：
- HLAE 是否正确安装
- CS2 是否已安装并可正常启动
- 数据库中是否有该 Demo 的训练窗口数据（需先执行"分析入库"）

### Q2: 进度显示一直是 0/X？
**A**: 可能原因：
- 输出目录路径不正确
- 视频文件名不匹配（检查是 `video.mp4` 还是 `full_round.mp4`）
- 帧文件扩展名不匹配（需要 `.jpg` 或 `.png`）
- 点击 "🔄 刷新进度" 重新检测

### Q3: 可视化时提示找不到帧文件？
**A**: 检查 `data.json` 中的路径是否正确：
- 路径格式应为相对路径：`frames/frame_0000.jpg`
- 不应包含父级目录前缀

### Q4: 数据库连接失败？
**A**: 确认：
- PostgreSQL 服务是否运行
- 数据库密码是否正确
- 数据库名称是否为 `csdm`

### Q5: 录制速度太慢？
**A**: 调整以下参数：
- 提高 "录制倍速" (推荐 8-16)
- 降低 "每窗口帧数" (最低 4)
- 确保硬盘写入速度足够快（推荐 SSD）

### Q6: 右键打开文件夹无反应？
**A**:
- 刷新进度后再试
- 检查输出目录路径是否正确
- 确认文件夹确实存在

---

## 🔧 高级配置

### 修改 FFmpeg 路径
编辑 `scripts/cli-generate-hlae-video.mjs:23`：
```javascript
const FFMPEG_PATH = 'F:\\your\\path\\to\\ffmpeg.exe';
```

### 修改数据库配置
编辑 `main.js` 和 `scripts/smart-batch-hlae.mjs` 中的数据库连接参数：
```javascript
const client = new Client({
  host: '127.0.0.1',
  port: 5432,
  user: 'postgres',
  password: 'your_password',
  database: 'csdm'
});
```

### 修改可视化播放速度
编辑 `scripts/visualize_playback.py:232`：
```python
key = cv2.waitKey(10 if not paused else 0)  # 10ms = 100fps (4倍速)
```

### 自定义窗口采样参数
在 cs-demo-manager 的配置中修改训练窗口的提取规则（事件类型、时间窗口等）。

---

## 📦 文件结构

```
.
├── main.js                        # Electron 主进程
├── index.html                     # UI 界面
├── package.json                   # Node.js 依赖
├── cs-demo-manager/               # Demo 分析引擎
├── scripts/
│   ├── smart-batch-hlae.mjs       # 批量录制脚本
│   ├── cli-generate-hlae-video.mjs # 单回合录制脚本
│   ├── visualize_playback.py      # 可视化回放工具
│   └── install-plugin.mjs         # CS2 插件安装
└── README.md                      # 本文档
```

---

## 🎯 性能优化建议

1. **使用 SSD**: 输出目录放在 SSD 上可显著提升录制速度
2. **批量录制**: 一次性录制多个回合比单个录制效率更高
3. **倍速设置**: 8-16 倍速为最佳平衡点（过高可能导致丢帧）
4. **定期清理**: 删除不合格的训练数据以节省空间
5. **并行处理**: 分析入库和录制可以在不同机器上并行执行

---

## 📄 许可证
内部使用工具，请勿外传。

## 👥 维护者
CS2-AI-Team

---

**Happy Training! 🚀**
