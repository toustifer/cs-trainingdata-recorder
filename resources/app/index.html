<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CS2 Data Reaper - Industrial Edition</title>
    <style>
        :root { --bg: #121212; --surface: #1e1e1e; --primary: #ff9800; --accent: #2196f3; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }

        .sidebar { width: 350px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .db-panel { width: 400px; background: #181818; border-left: 1px solid #333; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-header { padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; color: var(--primary); }
        #file-list { flex: 1; overflow-y: auto; padding: 0; }
        .file-item { padding: 10px 15px; border-bottom: 1px solid #2a2a2a; font-size: 13px; cursor: pointer; user-select: none; transition: all 0.2s; }
        .file-item:hover { background: #252525; }
        .file-item.selected { background: #2a4a6a; border-left: 3px solid var(--accent); }
        .file-item.all-files { font-weight: bold; color: var(--primary); background: #222; }
        .file-item.all-files.selected { background: #3a3a0a; border-left-color: var(--primary); }
        .file-name { color: #fff; display: block; margin-bottom: 4px; word-break: break-all; }
        .file-status { color: #888; font-size: 11px; }
        .file-players { margin-top: 5px; color: #aaa; font-size: 11px; line-height: 1.4; padding-left: 8px; border-left: 2px solid var(--accent); display: none; }
        .file-players.visible { display: block; }
        .file-players div { padding: 2px 4px; cursor: pointer; transition: background 0.2s; border-radius: 2px; }
        .file-players div:hover { background: #333; color: #fff; }
        .file-players div:active { background: var(--accent); }
        .player-progress { font-size: 10px; margin-left: 5px; padding: 1px 5px; border-radius: 3px; }
        .player-progress.complete { background: #2e7d32; color: #fff; }
        .player-progress.partial { background: #f57c00; color: #fff; }
        .player-progress.none { background: #555; color: #aaa; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; min-width: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .title { font-size: 24px; font-weight: bold; color: var(--primary); }
        .card { background: var(--surface); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 20px; flex-shrink: 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #888; text-transform: uppercase; }
        .row { display: flex; gap: 10px; }
        input { flex: 1; background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; outline: none; }
        button { background: var(--accent); border: none; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        button.primary { background: var(--primary); font-weight: bold; width: 100%; padding: 15px; font-size: 18px; }
        button.secondary { background: var(--accent); font-weight: bold; width: 100%; padding: 12px; font-size: 14px; margin-bottom: 10px; }
        #log { flex: 1; background: #000; color: #00ff00; font-family: 'Consolas', monospace; padding: 15px; border-radius: 4px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; border: 1px solid #333; min-height: 0; max-height: 500px; }
        .progress-container { width: 100%; background: #333; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; flex-shrink: 0; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        
        /* ç®€å•çš„å¤åˆ¶åé¦ˆæç¤º */
        .copy-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        
        .data-list { max-height: 200px; overflow-y: auto; background: #111; border: 1px solid #333; border-radius: 4px; margin-top: 10px; }
        .data-item { padding: 8px 12px; border-bottom: 1px solid #222; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .data-item:hover { background: #252525; }
        .data-item .name { font-weight: bold; color: #fff; }
        .data-item .time { color: #666; font-size: 11px; }
        .data-item .action { color: var(--accent); }

        /* æ•°æ®åº“é¢æ¿æ ·å¼ */
        .db-section { padding: 15px; border-bottom: 1px solid #333; }
        .db-stat-card { background: #252525; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--accent); }
        .db-stat-title { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .db-stat-value { font-size: 24px; font-weight: bold; color: var(--primary); }
        .db-stat-sub { font-size: 10px; color: #666; margin-top: 3px; }
        .db-demo-list { max-height: 400px; overflow-y: auto; }
        .db-demo-item { background: #222; padding: 10px; margin-bottom: 8px; border-radius: 4px; font-size: 11px; border-left: 2px solid #444; transition: all 0.2s; }
        .db-demo-item:hover { background: #2a2a2a; border-left-color: var(--accent); }
        .db-demo-name { color: #fff; font-weight: bold; margin-bottom: 5px; word-break: break-all; }
        .db-demo-checksum { color: #666; font-family: 'Consolas', monospace; font-size: 10px; }
        .db-demo-windows { color: var(--primary); font-size: 10px; margin-top: 5px; }
        .db-connection-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .db-connection-status.connected { background: #4caf50; box-shadow: 0 0 6px #4caf50; }
        .db-connection-status.disconnected { background: #f44336; box-shadow: 0 0 6px #f44336; }

        /* è‡ªåŠ¨åˆ·æ–°è„‰å†²åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .db-connection-status.auto-refresh {
            animation: pulse 2s ease-in-out infinite;
        }

        /* æ‚¬æµ®æ—¥å¿—çª—å£ */
        .log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .log-modal.show {
            display: flex;
        }
        .log-modal-content {
            background: #1a1a1a;
            border: 2px solid var(--primary);
            border-radius: 8px;
            width: 90%;
            height: 85%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }
        .log-modal-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #000;
            font-weight: bold;
        }
        .log-modal-header .controls {
            display: flex;
            gap: 10px;
        }
        .log-modal-header button {
            padding: 6px 12px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s;
        }
        .log-modal-header button:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        .log-modal-body {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .log-modal-log {
            flex: 1;
            background: #000;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 4px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 13px;
            border: 1px solid #333;
        }
        .log-modal-progress {
            width: 100%;
            background: #333;
            height: 12px;
            border-radius: 6px;
            margin-top: 15px;
            overflow: hidden;
        }
        .log-modal-progress-bar {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div id="toast" class="copy-toast">å·²å¤åˆ¶å¹¶å¡«å…¥ Steam ID</div>

    <!-- æ‚¬æµ®æ—¥å¿—çª—å£ -->
    <div id="logModal" class="log-modal">
        <div class="log-modal-content">
            <div class="log-modal-header">
                <h3>ğŸ“Š å®æ—¶æ—¥å¿—ç›‘æ§</h3>
                <div class="controls">
                    <button onclick="window.clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                    <button onclick="window.copyLog()">ğŸ“‹ å¤åˆ¶æ—¥å¿—</button>
                    <button onclick="window.killAllTasks()" style="background: rgba(198, 40, 40, 0.5); border-color: rgba(211, 47, 47, 0.7);">â›” ç»ˆæ­¢æ‰€æœ‰ä»»åŠ¡</button>
                    <button onclick="window.closeLogModal()">âœ• å…³é—­</button>
                </div>
            </div>
            <div class="log-modal-body">
                <div id="logModalContent" class="log-modal-log">ç­‰å¾…ä»»åŠ¡æŒ‡ä»¤...</div>
                <div class="log-modal-progress">
                    <div id="logModalProgressBar" class="log-modal-progress-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Demo æ–‡ä»¶åˆ—è¡¨</span>
            <div style="display: flex; gap: 5px;">
                <button onclick="window.openSelectedDemoFolder()" id="openDemoFolderBtn" style="padding: 4px 10px; font-size: 11px; background: #444; border: 1px solid #666; border-radius: 4px; cursor: pointer; color: #aaa;">
                    ğŸ“ æ‰“å¼€æ–‡ä»¶å¤¹
                </button>
                <button onclick="window.refreshProgress()" id="refreshProgressBtn" style="padding: 4px 10px; font-size: 11px; background: #444; border: 1px solid #666; border-radius: 4px; cursor: pointer; color: #aaa;">
                    åˆ·æ–°è¿›åº¦
                </button>
            </div>
        </div>
        <div id="file-list">
            <div style="padding:15px; color:#666; text-align:center;">è¯·é€‰æ‹© Demo ç›®å½•</div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="title">CS2 DATA REAPER <span style="color: #fff; font-size: 14px; margin-left: 10px;">Dual Mode</span></div>
            <button onclick="openConfigFolder()" style="font-size: 12px;">æ‰“å¼€é…ç½®æ–‡ä»¶å¤¹</button>
        </div>

        <div class="card">
            <div class="grid">
                <div class="input-group"><label>Demo æ€»ç›®å½•</label><div class="row"><input type="text" id="demoDir"><button onclick="window.selectDir('demoDir')">æµè§ˆ</button></div></div>
                <div class="input-group"><label>è¾“å‡ºä¸»ç›®å½•</label><div class="row"><input type="text" id="outputDir"><button onclick="window.selectDir('outputDir')">æµè§ˆ</button></div></div>
            </div>
            <div class="grid">
                <div class="input-group"><label>æ•°æ®åº“å¯†ç </label><input type="password" id="dbPass" value="88683139"></div>
                <div class="input-group"><label>å›åˆå· (ä¾‹å¦‚: 1,2,3 æˆ–ç•™ç©ºä¸ºå…¨éƒ¨)</label><input type="text" id="rounds" placeholder="1,2,3,4..."></div>
            </div>
            <div class="grid">
                <div class="input-group"><label>ç©å®¶ Steam ID (ç•™ç©º=å½•åˆ¶æ‰€æœ‰ç©å®¶)</label><input type="text" id="steamId" placeholder="ç•™ç©ºå½•åˆ¶æ‰€æœ‰ç©å®¶ï¼Œæˆ–ç‚¹å‡»å·¦ä¾§ç©å®¶åå¡«å…¥"></div>
                <div class="input-group"><label>å½•åˆ¶å€é€Ÿ (é»˜è®¤ 8)</label><input type="number" id="speed" value="8"></div>
                <div class="input-group"><label>æ¯çª—å£å¸§æ•° (é»˜è®¤ 10)</label><input type="number" id="framesPerWindow" value="10" min="2" max="30"></div>
            </div>
            <div style="margin: 10px 0; padding: 8px; background: #1a1a2e; border-radius: 4px;">
                <label style="display: flex; align-items: center; cursor: pointer; color: #ff6b6b;">
                    <input type="checkbox" id="forceReanalyze" style="margin-right: 8px; width: 18px; height: 18px;">
                    <span>å¼ºåˆ¶é‡æ–°å¯¼å‡ºè®­ç»ƒçª—å£ (è¦†ç›–æ•°æ®åº“ä¸­å·²æœ‰æ•°æ®)</span>
                </label>
            </div>

            <div style="margin: 10px 0; padding: 8px; background: #2a1a1a; border-radius: 4px; border: 1px solid #d32f2f;">
                <button onclick="window.clearDatabase()" style="width: 100%; padding: 10px; font-size: 13px; background: #c62828; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold;">
                    ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“æ‰€æœ‰è¡¨ (æ…ç”¨ï¼)
                </button>
                <div style="margin-top: 5px; font-size: 10px; color: #999;">
                    å®Œå…¨æ¸…ç©º demos, matches, training_windows è¡¨ï¼Œè§£å†³æ•°æ®åº“åŒæ­¥é—®é¢˜
                </div>
            </div>

            <!-- ä¸€é”®å…¨æµç¨‹æŒ‰é’® -->
            <div style="margin-bottom: 10px;">
                <button onclick="window.startFullPipeline()"
                        style="width: 100%; padding: 15px; font-size: 16px; font-weight: bold;
                               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               border: none; border-radius: 8px; cursor: pointer; color: white;
                               box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                    ğŸš€ ä¸€é”®å…¨æµç¨‹ï¼ˆåˆ†æ+å½•åˆ¶ï¼‰
                </button>
                <div style="margin-top: 5px; font-size: 11px; color: #999; text-align: center;">
                    è‡ªåŠ¨é€ä¸ªå¤„ç†ï¼šåˆ†ædemo â†’ å½•åˆ¶è§†é¢‘ â†’ ä¸‹ä¸€ä¸ªdemo
                </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1.5fr 0.8fr;">
                <button class="secondary" id="analyzeBtn" onclick="window.startAnalysis()">1. åˆ†æå…¥åº“</button>
                <button class="primary" id="startBtn" onclick="window.startHarvest()">2. å¯åŠ¨å½•åˆ¶æ”¶å‰²</button>
                <button class="secondary" style="background: #4caf50;" onclick="window.startVisualize()">3. å¯è§†åŒ–(é…ç½®)</button>
            </div>
        </div>

        <!-- æ–°å¢ï¼šé€‰æ‹©æ–‡ä»¶å¤¹æ’­æ”¾æŒ‰é’® -->
        <div class="card" style="padding: 15px; margin-bottom: 10px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="window.selectFolderToVisualize()" style="width: 100%; padding: 12px; font-size: 14px; background: linear-gradient(135deg, #4a9eff, #6c5ce7); border: none; border-radius: 6px; cursor: pointer; color: white;">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹æ’­æ”¾
                </button>
                <button onclick="window.browseDemoVisualization()" style="width: 100%; padding: 12px; font-size: 14px; background: linear-gradient(135deg, #f093fb, #f5576c); border: none; border-radius: 6px; cursor: pointer; color: white;">
                    ğŸ¬ é€‰æ‹©Demoæµè§ˆ
                </button>
            </div>
        </div>

        <!-- æ—¥å¿—æ§åˆ¶æŒ‰é’® -->
        <div style="display: flex; gap: 10px; margin-bottom: 5px;">
            <button onclick="window.openLogModal()" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, var(--primary), var(--accent)); border: 1px solid var(--primary); border-radius: 4px; cursor: pointer; color: #fff; font-weight: bold;">
                ğŸªŸ å¼¹å‡ºæ—¥å¿—
            </button>
            <button onclick="window.clearLog()" style="padding: 6px 12px; font-size: 12px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer; color: #aaa;">
                ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—
            </button>
            <button onclick="window.copyLog()" style="padding: 6px 12px; font-size: 12px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer; color: #aaa;">
                ğŸ“‹ å¤åˆ¶æ—¥å¿—
            </button>
            <button onclick="window.killAllTasks()" style="padding: 6px 12px; font-size: 12px; background: #c62828; border: 1px solid #d32f2f; border-radius: 4px; cursor: pointer; color: #fff;">
                â›” ç»ˆæ­¢æ‰€æœ‰ä»»åŠ¡
            </button>
        </div>

        <div id="log">ç­‰å¾…ä»»åŠ¡æŒ‡ä»¤...</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
    </div>

    <!-- å³ä¾§æ•°æ®åº“çŠ¶æ€é¢æ¿ -->
    <div class="db-panel">
        <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span>
                <span class="db-connection-status" id="dbConnectionStatus"></span>
                æ•°æ®åº“çŠ¶æ€
            </span>
            <div style="display: flex; gap: 5px; align-items: center;">
                <label style="display: flex; align-items: center; cursor: pointer; margin: 0; font-size: 10px; color: #888; text-transform: none;">
                    <input type="checkbox" id="autoRefreshDb" checked style="margin-right: 3px; width: 14px; height: 14px;">
                    <span>è‡ªåŠ¨</span>
                </label>
                <button onclick="window.refreshDatabaseStatus(true)" id="refreshDbBtn" style="padding: 4px 10px; font-size: 11px; background: #444; border: 1px solid #666; border-radius: 4px; cursor: pointer; color: #aaa;">
                    ğŸ”„
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="db-section">
            <div class="db-stat-card">
                <div class="db-stat-title">Demos è¡¨</div>
                <div class="db-stat-value" id="dbDemosCount">-</div>
                <div class="db-stat-sub">Demo æ–‡ä»¶è®°å½•</div>
            </div>
            <div class="db-stat-card">
                <div class="db-stat-title">Matches è¡¨</div>
                <div class="db-stat-value" id="dbMatchesCount">-</div>
                <div class="db-stat-sub">æ¯”èµ›è®°å½•</div>
            </div>
            <div class="db-stat-card">
                <div class="db-stat-title">Training Windows è¡¨</div>
                <div class="db-stat-value" id="dbWindowsCount">-</div>
                <div class="db-stat-sub">è®­ç»ƒçª—å£æ•°æ®</div>
            </div>
        </div>

        <!-- Demo åˆ—è¡¨ -->
        <div class="db-section" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
            <div style="font-size: 12px; color: #888; margin-bottom: 10px; text-transform: uppercase;">æœ€è¿‘çš„ Demos (æŒ‰æ—¥æœŸ)</div>
            <div class="db-demo-list" id="dbDemoList">
                <div style="padding: 20px; color: #666; text-align: center;">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ•°æ®</div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');

        console.log("Script loaded successfully");

        let selectedFile = null; // null è¡¨ç¤ºé€‰æ‹©å…¨éƒ¨ï¼Œå¦åˆ™ä¸ºå…·ä½“æ–‡ä»¶è·¯å¾„
        let dbAutoRefreshTimer = null; // æ•°æ®åº“è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨

        // æ˜¾å¼æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œç¡®ä¿ HTML onclick èƒ½æ‰¾åˆ°
        window.selectDir = async function(id) {
            console.log("selectDir called for " + id);
            const dirPath = await ipcRenderer.invoke('select-dir');
            if (dirPath) {
                document.getElementById(id).value = dirPath;
                if (id === 'demoDir') {
                    window.refreshDemoList(dirPath);
                }
            }
        };

        window.refreshDataList = async function(dirPath) {
            if (!dirPath) dirPath = document.getElementById('outputDir').value;
            if (!dirPath) return;

            const listEl = document.getElementById('data-list');
            listEl.innerHTML = '<div style="padding:10px; color:#888; text-align:center;">æ‰«æä¸­...</div>';

            const folders = await ipcRenderer.invoke('scan-training-data', dirPath);
            listEl.innerHTML = '';

            if (folders.length === 0) {
                listEl.innerHTML = '<div style="padding:10px; color:#888; text-align:center;">è¯¥ç›®å½•ä¸‹æš‚æ— è®­ç»ƒæ•°æ®</div>';
                return;
            }

            folders.forEach(f => {
                const item = document.createElement('div');
                item.className = 'data-item';
                const dateStr = new Date(f.mtime).toLocaleString();
                item.innerHTML = `
                    <span class="name">${f.name}</span>
                    <div>
                        <span class="time">${dateStr}</span>
                        <span class="action">â–¶ æ’­æ”¾</span>
                    </div>
                `;
                item.onclick = () => window.visualizeFolder(f.path);
                listEl.appendChild(item);
            });
        };

        window.visualizeFolder = function(folderPath) {
            window.appendLog(`\n>>> è¯·æ±‚æ’­æ”¾æ•°æ®: ${folderPath}\n`);
            ipcRenderer.send('start-visualization', { targetFolder: folderPath });
        };

        window.selectFolderToVisualize = async function() {
            // é»˜è®¤æ‰“å¼€è¾“å‡ºä¸»ç›®å½•
            const defaultPath = document.getElementById('outputDir').value;
            const folderPath = await ipcRenderer.invoke('select-dir', defaultPath);
            if (folderPath) {
                window.visualizeFolder(folderPath);
            }
        };

        window.killAllTasks = async function() {
            if (!confirm('ç¡®å®šè¦ç»ˆæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å—ï¼Ÿ\nè¿™å°†å¼ºåˆ¶ç»“æŸæ‰€æœ‰è¿›ç¨‹ï¼ˆå½•åˆ¶ã€å¯è§†åŒ–ç­‰ï¼‰')) {
                return;
            }

            window.appendLog('\n>>> æ­£åœ¨ç»ˆæ­¢æ‰€æœ‰ä»»åŠ¡...\n');
            const result = await ipcRenderer.invoke('kill-all-tasks');

            if (result.success) {
                window.appendLog(`[OK] å·²ç»ˆæ­¢ ${result.count} ä¸ªè¿›ç¨‹\n`);

                // é‡ç½®æµè§ˆçŠ¶æ€
                currentBrowseState = null;

                // é‡æ–°å¯ç”¨æŒ‰é’®
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('startBtn').disabled = false;
            } else {
                window.appendLog(`[é”™è¯¯] ${result.error}\n`);
            }
        };

        window.clearDatabase = async function() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†å®Œå…¨æ¸…ç©ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nå°†åˆ é™¤ä»¥ä¸‹è¡¨çš„æ‰€æœ‰è®°å½•ï¼š\n- demos\n- matches\n- training_windows\n- æ‰€æœ‰ç›¸å…³è”çš„è¡¨\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            if (!confirm('æœ€åç¡®è®¤ï¼šä½ ç¡®å®šè¦æ¸…ç©ºæ•°æ®åº“å—ï¼Ÿ\n\næ‰€æœ‰å·²åˆ†æçš„æ•°æ®éƒ½ä¼šä¸¢å¤±ï¼')) {
                return;
            }

            const dbPass = document.getElementById('dbPass').value;
            if (!dbPass) {
                window.appendLog('\n[é”™è¯¯] è¯·å…ˆè¾“å…¥æ•°æ®åº“å¯†ç \n');
                return;
            }

            window.appendLog('\n>>> å¼€å§‹æ¸…ç©ºæ•°æ®åº“...\n');

            try {
                const result = await ipcRenderer.invoke('clear-database', {
                    dbUser: 'postgres',
                    dbPass: dbPass
                });

                if (result.error) {
                    window.appendLog(`[é”™è¯¯] æ¸…ç©ºå¤±è´¥: ${result.error}\n`);
                } else {
                    window.appendLog(`[æˆåŠŸ] å·²æ¸…ç©ºæ‰€æœ‰è¡¨\n`);
                    window.appendLog(`  - demos: ${result.demosDeleted} æ¡\n`);
                    window.appendLog(`  - matches: ${result.matchesDeleted} æ¡\n`);
                    window.appendLog(`  - training_windows: ${result.windowsDeleted} æ¡\n`);
                    window.appendLog(`\nâœ“ æ•°æ®åº“å·²å®Œå…¨æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°å¼€å§‹åˆ†æ\n`);

                    // åˆ·æ–°æ•°æ®åº“çŠ¶æ€
                    window.refreshDatabaseStatus();
                }
            } catch (err) {
                window.appendLog(`[é”™è¯¯] ${err.message}\n`);
            }
        };

        window.refreshDemoList = async function(dirPath) {
            const listEl = document.getElementById('file-list');
            listEl.innerHTML = '<div style="padding:15px; color:#888;">æ‰«æä¸­...</div>';

            const demos = await ipcRenderer.invoke('scan-demos', dirPath);
            listEl.innerHTML = '';

            // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
            const allItem = document.createElement('div');
            allItem.className = 'file-item all-files selected';
            allItem.dataset.path = 'ALL';
            allItem.innerHTML = `
                <span class="file-name">âœ“ å…¨éƒ¨æ–‡ä»¶</span>
                <span class="file-status">ç‚¹å‡»ä¸‹æ–¹æ–‡ä»¶å¯å•ç‹¬é€‰æ‹©</span>
            `;
            allItem.onclick = () => window.selectFileItem(allItem, null);
            listEl.appendChild(allItem);

            if (demos.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'padding:15px; color:#888; text-align:center;';
                emptyDiv.innerText = 'æœªæ‰¾åˆ° .dem æ–‡ä»¶';
                listEl.appendChild(emptyDiv);
                return;
            }

            demos.forEach(filePath => {
                const fileName = filePath.split(/[\\/]/).pop();
                const item = document.createElement('div');
                item.className = 'file-item';
                item.id = 'file-' + Buffer.from(filePath).toString('base64').replace(/[+/=]/g, '');
                item.dataset.path = filePath;
                item.innerHTML = `
                    <span class="file-name">${fileName}</span>
                    <span class="file-status">ç­‰å¾…æ£€æŸ¥...</span>
                    <div class="file-players"></div>
                `;
                item.onclick = () => window.selectFileItem(item, filePath);
                listEl.appendChild(item);
            });

            // è‡ªåŠ¨è§¦å‘æ‰¹é‡åå°æ£€æŸ¥
            const config = {
                files: demos,
                dbUser: 'postgres',
                dbPass: document.getElementById('dbPass').value
            };
            ipcRenderer.send('quick-scan-players', config);
        };

        window.selectFileItem = function(itemEl, filePath) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
            // æ·»åŠ å½“å‰é€‰ä¸­
            itemEl.classList.add('selected');
            selectedFile = filePath; // null è¡¨ç¤ºå…¨éƒ¨

            // æ›´æ–°UIæç¤º
            if (filePath === null) {
                window.appendLog('\n[å·²é€‰æ‹©] å…¨éƒ¨æ–‡ä»¶\n');
                // é€‰æ‹©å…¨éƒ¨æ—¶æ¸…ç©º Steam IDï¼Œå½•åˆ¶æ—¶ä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰ç©å®¶
                document.getElementById('steamId').value = '';
            } else {
                const fileName = filePath.split(/[\\/]/).pop();
                window.appendLog(`\n[å·²é€‰æ‹©] ${fileName}\n`);
                // é€‰æ‹©å•ä¸ª demo æ—¶ä¹Ÿæ¸…ç©º Steam IDï¼Œæ–¹ä¾¿å½•åˆ¶æ‰€æœ‰ç©å®¶
                document.getElementById('steamId').value = '';
                window.appendLog('[æç¤º] Steam ID å·²æ¸…ç©ºï¼Œå°†å½•åˆ¶è¯¥ demo æ‰€æœ‰ç©å®¶ã€‚ç‚¹å‡»å·¦ä¾§ç©å®¶åå¯åªå½•åˆ¶å•ä¸ªç©å®¶ã€‚\n');
            }
        };

        window.openConfigFolder = async function() {
            await ipcRenderer.invoke('open-config-folder');
        };

        window.openSelectedDemoFolder = async function() {
            if (!selectedFile) {
                window.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Demo æ–‡ä»¶');
                return;
            }

            const outputDir = document.getElementById('outputDir').value;
            if (!outputDir || outputDir.trim() === '') {
                window.showToast('è¯·å…ˆè®¾ç½®è¾“å‡ºä¸»ç›®å½•');
                return;
            }

            // è·å–demoæ–‡ä»¶åï¼ˆå»æ‰.demæ‰©å±•åï¼‰
            const path = require('path');
            const demoFileName = path.basename(selectedFile, '.dem');

            // æ„å»ºè¾“å‡ºç›®å½•è·¯å¾„ï¼šè¾“å‡ºä¸»ç›®å½•/demoåç§°
            const demoOutputFolder = path.join(outputDir, demoFileName);

            window.appendLog(`\n[æ‰“å¼€æ–‡ä»¶å¤¹] ${demoOutputFolder}\n`);

            try {
                const result = await ipcRenderer.invoke('open-folder', demoOutputFolder);
                if (result && result.error) {
                    window.showToast('æ‰“å¼€å¤±è´¥: ' + result.error);
                } else {
                    window.showToast('æ­£åœ¨æ‰“å¼€æ–‡ä»¶å¤¹...');
                }
            } catch (err) {
                window.showToast('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + err.message);
            }
        };

        window.appendLog = function(text) {
            const log = document.getElementById('log');
            const logModal = document.getElementById('logModalContent');

            log.innerText += text;
            logModal.innerText += text;  // åŒæ­¥åˆ°æ‚¬æµ®çª—å£

            // é™åˆ¶æ—¥å¿—å¤§å°ï¼šæœ€å¤šä¿ç•™æœ€å 2000 è¡Œæˆ– 500KB å­—ç¬¦
            const MAX_LINES = 2000;
            const MAX_CHARS = 500000;

            let lines = log.innerText.split('\n');
            if (lines.length > MAX_LINES) {
                lines = lines.slice(-MAX_LINES);
                const cleanedLog = '... (å·²è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—) ...\n\n' + lines.join('\n');
                log.innerText = cleanedLog;
                logModal.innerText = cleanedLog;  // åŒæ­¥åˆ°æ‚¬æµ®çª—å£
            } else if (log.innerText.length > MAX_CHARS) {
                // æŒ‰å­—ç¬¦æ•°é™åˆ¶
                const cleanedLog = '... (å·²è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—) ...\n\n' + log.innerText.slice(-MAX_CHARS);
                log.innerText = cleanedLog;
                logModal.innerText = cleanedLog;  // åŒæ­¥åˆ°æ‚¬æµ®çª—å£
            }

            log.scrollTop = log.scrollHeight;
            logModal.scrollTop = logModal.scrollHeight;  // åŒæ­¥æ»šåŠ¨

            if (text.includes('[')) {
                const match = text.match(/\['.*?(\d+)\/(\d+)\]/);
                if (match) {
                    const progress = (parseInt(match[1])/parseInt(match[2])*100);
                    document.getElementById('progress-bar').style.width = progress + '%';
                    document.getElementById('logModalProgressBar').style.width = progress + '%';  // åŒæ­¥è¿›åº¦æ¡
                }
            }
        };

        window.clearLog = function() {
            document.getElementById('log').innerText = 'æ—¥å¿—å·²æ¸…é™¤\n';
            document.getElementById('logModalContent').innerText = 'æ—¥å¿—å·²æ¸…é™¤\n';  // åŒæ­¥åˆ°æ‚¬æµ®çª—å£
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('logModalProgressBar').style.width = '0%';  // åŒæ­¥è¿›åº¦æ¡
        };

        window.openLogModal = function() {
            const modal = document.getElementById('logModal');
            modal.classList.add('show');
            // åŒæ­¥å½“å‰æ—¥å¿—å†…å®¹
            const currentLog = document.getElementById('log').innerText;
            document.getElementById('logModalContent').innerText = currentLog;
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                document.getElementById('logModalContent').scrollTop = document.getElementById('logModalContent').scrollHeight;
            }, 100);
        };

        window.closeLogModal = function() {
            const modal = document.getElementById('logModal');
            modal.classList.remove('show');
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('logModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    window.closeLogModal();
                }
            });

            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    window.closeLogModal();
                }
            });
        });

        window.copyLog = function() {
            const logText = document.getElementById('log').innerText;
            try {
                // ä½¿ç”¨ Electron çš„ clipboard æ¨¡å—
                const { clipboard } = require('electron');
                clipboard.writeText(logText);

                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = '#2e7d32';
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = '#333';
                }, 1500);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // å¤‡ç”¨æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬æ¡†
                const textarea = document.createElement('textarea');
                textarea.value = logText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        };

        window.startAnalysis = function() {
            console.log("startAnalysis clicked");
            const demoDir = document.getElementById('demoDir').value;
            const rounds = document.getElementById('rounds').value.trim();
            const forceReanalyze = document.getElementById('forceReanalyze').checked;

            const config = {
                demoDir: demoDir,
                selectedFile: selectedFile, // null=å…¨éƒ¨ï¼Œå¦åˆ™ä¸ºå…·ä½“æ–‡ä»¶è·¯å¾„
                rounds: rounds, // å¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²
                dbUser: 'postgres',
                dbPass: document.getElementById('dbPass').value,
                forceReanalyze: forceReanalyze
            };

            document.getElementById('analyzeBtn').disabled = true;

            if (selectedFile === null) {
                window.appendLog("\n>>> å¼€å§‹æ‰¹é‡åˆ†ææ‰€æœ‰æ–‡ä»¶...\n");
            } else {
                const fileName = selectedFile.split(/[\\/]/).pop();
                window.appendLog(`\n>>> å¼€å§‹åˆ†æå•ä¸ªæ–‡ä»¶: ${fileName}\n`);
                if (rounds) {
                    window.appendLog(`>>> æŒ‡å®šå›åˆ: ${rounds}\n`);
                }
            }

            // é‡ç½®çŠ¶æ€
            document.querySelectorAll('.file-status').forEach(el => {
                if (!el.closest('.all-files')) {
                    el.innerText = 'ç­‰å¾…å¤„ç†';
                }
            });
            document.querySelectorAll('.file-players').forEach(el => {
                el.innerHTML = '';
                el.classList.remove('visible');
            });

            ipcRenderer.send('start-analysis', config);
        };

        window.startHarvest = async function() {
            console.log("startHarvest clicked");
            const rounds = document.getElementById('rounds').value.trim();
            const forceReanalyze = document.getElementById('forceReanalyze').checked;

            const config = {
                demoDir: document.getElementById('demoDir').value,
                outputDir: document.getElementById('outputDir').value,
                playerSteamId: document.getElementById('steamId').value,
                selectedFile: selectedFile, // null=å…¨éƒ¨ï¼Œå¦åˆ™ä¸ºå…·ä½“æ–‡ä»¶è·¯å¾„
                rounds: rounds,
                dbUser: 'postgres',
                dbPass: document.getElementById('dbPass').value,
                speed: document.getElementById('speed').value,
                framesPerWindow: document.getElementById('framesPerWindow').value,
                forceReanalyze: forceReanalyze
            };

            await ipcRenderer.invoke('save-config', config);
            document.getElementById('startBtn').disabled = true;

            if (selectedFile === null) {
                window.appendLog("\n>>> å¯åŠ¨æ‰¹é‡å½•åˆ¶æ”¶å‰²æµç¨‹ï¼ˆæ‰€æœ‰æ–‡ä»¶ï¼‰...\n");
            } else {
                const fileName = selectedFile.split(/[\\/]/).pop();
                window.appendLog(`\n>>> å¯åŠ¨å•æ–‡ä»¶å½•åˆ¶: ${fileName}\n`);
                if (rounds) {
                    window.appendLog(`>>> æŒ‡å®šå›åˆ: ${rounds}\n`);
                }
            }

            ipcRenderer.send('start-process', config);
        };

        window.startFullPipeline = async function() {
            console.log("startFullPipeline clicked");

            const config = {
                demoDir: document.getElementById('demoDir').value,
                outputDir: document.getElementById('outputDir').value,
                playerSteamId: document.getElementById('steamId').value,
                selectedFile: selectedFile, // null=å…¨éƒ¨ï¼Œå¦åˆ™ä¸ºå…·ä½“æ–‡ä»¶è·¯å¾„
                rounds: document.getElementById('rounds').value.trim(),
                dbUser: 'postgres',
                dbPass: document.getElementById('dbPass').value,
                speed: document.getElementById('speed').value,
                framesPerWindow: document.getElementById('framesPerWindow').value
            };

            await ipcRenderer.invoke('save-config', config);

            if (selectedFile === null) {
                window.appendLog("\nğŸš€ ========== ä¸€é”®å…¨æµç¨‹å¯åŠ¨ ==========\n");
                window.appendLog(">>> æ¨¡å¼: æ‰¹é‡å¤„ç†æ‰€æœ‰demo\n");
                window.appendLog(">>> æµç¨‹: é€ä¸ªdemoæ‰§è¡Œ [åˆ†æâ†’å½•åˆ¶â†’ä¸‹ä¸€ä¸ª]\n");
                window.appendLog(">>> æç¤º: å¯éšæ—¶ç‚¹å‡» 'â›” ç»ˆæ­¢æ‰€æœ‰ä»»åŠ¡' åœæ­¢\n");
                window.appendLog("==========================================\n\n");
            } else {
                const fileName = selectedFile.split(/[\\/]/).pop();
                window.appendLog(`\nğŸš€ ========== ä¸€é”®å…¨æµç¨‹å¯åŠ¨ ==========\n`);
                window.appendLog(`>>> æ¨¡å¼: å•æ–‡ä»¶å¤„ç†\n`);
                window.appendLog(`>>> æ–‡ä»¶: ${fileName}\n`);
                window.appendLog(`>>> æµç¨‹: [åˆ†æâ†’å½•åˆ¶]\n`);
                window.appendLog("==========================================\n\n");
            }

            ipcRenderer.send('start-full-pipeline', config);
        };

        window.startVisualize = function() {
            const rounds = document.getElementById('rounds').value.trim();
            const steamId = document.getElementById('steamId').value.trim();

            if (!selectedFile || selectedFile === 'ALL') {
                window.appendLog('\n[æç¤º] å¯è§†åŒ–åªèƒ½é’ˆå¯¹å•ä¸ªæ–‡ä»¶ã€‚è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ª Demoã€‚\n');
                return;
            }
            if (!steamId) {
                window.appendLog('\n[æç¤º] è¯·å¡«å†™è¦å¯è§†åŒ–çš„ç©å®¶ Steam IDã€‚\n');
                return;
            }
            if (!rounds) {
                window.appendLog('\n[æç¤º] è¯·å¡«å†™å…·ä½“çš„ä¸€ä¸ªå›åˆå· (ä¾‹å¦‚: 1)ã€‚\n');
                return;
            }

            const config = {
                outputDir: document.getElementById('outputDir').value,
                selectedFile: selectedFile,
                playerSteamId: steamId,
                rounds: rounds
            };

            window.appendLog(`\n>>> æ­£åœ¨å¯åŠ¨å¯è§†åŒ–å·¥å…·...\n`);
            ipcRenderer.send('start-visualization', config);
        };

        window.showToast = function(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        };

        window.copyToClipboard = async function(text) {
            try {
                // å¦‚æœæ ¼å¼æ˜¯ "Name [ID]"ï¼Œæˆ‘ä»¬åªå¤åˆ¶ ID åˆ°å‰ªè´´æ¿ï¼Œè¿˜æ˜¯å¤åˆ¶æ•´è¡Œï¼Ÿ
                // é€šå¸¸ç”¨æˆ·ç‚¹å‡»æ˜¯ä¸ºäº†å¡«å…¥ï¼Œæ‰€ä»¥æœ€å¥½æå– IDã€‚
                // 1. å°è¯•æå– [12345] ä¸­çš„ ID
                let idToFill = text;
                const bracketMatch = text.match(/\[(\d{17})\]/);
                if (bracketMatch) {
                    idToFill = bracketMatch[1];
                }

                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                await navigator.clipboard.writeText(idToFill);

                // 2. å°è¯•æå– Steam ID (é€šå¸¸æ˜¯ 17 ä½æ•°å­—)
                const steamIdMatch = idToFill.match(/\d{17}/);
                if (steamIdMatch) {
                    document.getElementById('steamId').value = steamIdMatch[0];
                    window.showToast(`å·²å¡«å…¥ ID: ${steamIdMatch[0]}`);
                } else {
                    window.showToast(`å·²å¤åˆ¶æ–‡æœ¬`);
                }
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        };

        // å³é”®æ‰“å¼€Demoæ–‡ä»¶å¤¹
        window.openDemoFolder = async function(folderPath) {
            console.log('[openDemoFolder] Called with path:', folderPath);
            window.appendLog(`\n[æ‰“å¼€æ–‡ä»¶å¤¹] ${folderPath}\n`);
            try {
                const result = await ipcRenderer.invoke('open-folder', folderPath);
                console.log('[openDemoFolder] Result:', result);
                if (result && result.error) {
                    window.showToast('æ‰“å¼€å¤±è´¥: ' + result.error);
                } else {
                    window.showToast('æ­£åœ¨æ‰“å¼€æ–‡ä»¶å¤¹...');
                }
            } catch (err) {
                console.error('Failed to open folder:', err);
                window.showToast('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + err.message);
            }
        };

        window.refreshProgress = async function() {
            const outputDir = document.getElementById('outputDir').value;
            if (!outputDir) {
                window.appendLog('\n[æç¤º] è¯·å…ˆè®¾ç½®è¾“å‡ºä¸»ç›®å½•\n');
                return;
            }

            const btn = document.getElementById('refreshProgressBtn');
            const originalText = btn.innerText;
            btn.innerText = 'åˆ·æ–°ä¸­...';
            btn.disabled = true;

            try {
                // å¦‚æœé€‰æ‹©äº†å…¨éƒ¨æ–‡ä»¶ï¼Œåˆ·æ–°æ‰€æœ‰
                if (selectedFile === null) {
                    const demoDir = document.getElementById('demoDir').value;
                    if (!demoDir) {
                        window.appendLog('\n[æç¤º] è¯·å…ˆé€‰æ‹© Demo ç›®å½•\n');
                        return;
                    }
                    const glob = require('fast-glob');
                    const demos = await glob('**/*.dem', { cwd: demoDir, absolute: true });

                    for (const demoPath of demos) {
                        await window.checkSingleDemoProgress(demoPath, outputDir);
                    }
                    window.appendLog('\n>>> å·²åˆ·æ–°æ‰€æœ‰ demo çš„å½•åˆ¶è¿›åº¦\n');
                } else {
                    // åªåˆ·æ–°é€‰ä¸­çš„å•ä¸ª demo
                    await window.checkSingleDemoProgress(selectedFile, outputDir);
                    window.appendLog('\n>>> å·²åˆ·æ–°å½“å‰ demo çš„å½•åˆ¶è¿›åº¦\n');
                }
            } catch (err) {
                window.appendLog(`\n[é”™è¯¯] åˆ·æ–°å¤±è´¥: ${err.message}\n`);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.checkSingleDemoProgress = async function(demoPath, outputDir) {
            const result = await ipcRenderer.invoke('check-recording-progress', {
                demoPath,
                outputDir,
                dbUser: 'postgres',
                dbPass: document.getElementById('dbPass').value
            });

            if (!result) return;

            // å¤„ç†é”™è¯¯æƒ…å†µ
            if (result.error) {
                window.appendLog(`\n[è­¦å‘Š] ${path.basename(demoPath)}: ${result.error}\n`);
                return;
            }

            // æ›´æ–°è¯¥ demo çš„ç©å®¶è¿›åº¦æ˜¾ç¤º
            const items = document.querySelectorAll('.file-item');
            for (let item of items) {
                if (item.dataset.path === demoPath) {
                    const playerEl = item.querySelector('.file-players');
                    if (result.players && result.players.length > 0) {
                        playerEl.innerHTML = result.players.map(p => {
                            const progressClass = p.completedRounds === p.totalRounds ? 'complete' :
                                                  p.completedRounds > 0 ? 'partial' : 'none';
                            const progressText = `${p.totalRounds}/${p.completedRounds}`;

                            // æ„å»ºæœªå®Œæˆå›åˆçš„æç¤ºæ–‡æœ¬
                            let tooltip = '';
                            if (p.incompleteRounds && p.incompleteRounds.length > 0) {
                                tooltip = `æœªå®Œæˆ: Round ${p.incompleteRounds.join(', ')}`;
                            } else {
                                tooltip = 'å…¨éƒ¨å®Œæˆ';
                            }

                            // å³é”®æ‰“å¼€æ–‡ä»¶å¤¹
                            const demoName = path.basename(demoPath, '.dem');
                            const folderPath = path.join(outputDir, demoName);

                            return `<div onclick="window.copyToClipboard(this.innerText)"
                                         oncontextmenu="window.openDemoFolder('${folderPath.replace(/\\/g, '\\\\')}'); return false;"
                                         style="cursor: pointer;"
                                         title="å·¦é”®å¤åˆ¶IDï¼Œå³é”®æ‰“å¼€æ–‡ä»¶å¤¹">
                                ${p.name} [${p.steamId}]
                                <span class="player-progress ${progressClass}" title="${tooltip}">${progressText}</span>
                            </div>`;
                        }).join('');
                        playerEl.classList.add('visible');
                    }
                    break;
                }
            }
        };

        // æ–°å¢ï¼šæµè§ˆDemoçš„æ‰€æœ‰è®­ç»ƒæ•°æ®
        let currentBrowseState = null; // { demoPath, folders: [], currentIndex: 0 }

        window.browseDemoVisualization = async function() {
            if (!selectedFile || selectedFile === 'ALL') {
                window.appendLog('\n[æç¤º] è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ª Demo æ–‡ä»¶\n');
                return;
            }

            const outputDir = document.getElementById('outputDir').value;
            if (!outputDir) {
                window.appendLog('\n[æç¤º] è¯·å…ˆè®¾ç½®è¾“å‡ºä¸»ç›®å½•\n');
                return;
            }

            window.appendLog(`\n>>> æ­£åœ¨æ‰«æ Demo çš„æ‰€æœ‰è®­ç»ƒæ•°æ®...\n`);

            // è°ƒç”¨IPCè·å–è¯¥demoçš„æ‰€æœ‰è®­ç»ƒæ•°æ®æ–‡ä»¶å¤¹
            const result = await ipcRenderer.invoke('get-demo-folders', {
                demoPath: selectedFile,
                outputDir: outputDir,
                dbUser: 'postgres',
                dbPass: document.getElementById('dbPass').value
            });

            if (result.error) {
                window.appendLog(`[é”™è¯¯] ${result.error}\n`);
                return;
            }

            if (!result.folders || result.folders.length === 0) {
                window.appendLog('[æç¤º] æœªæ‰¾åˆ°è¯¥ Demo çš„è®­ç»ƒæ•°æ®\n');
                return;
            }

            // ä¿å­˜æµè§ˆçŠ¶æ€
            currentBrowseState = {
                demoPath: selectedFile,
                folders: result.folders,
                currentIndex: 0
            };

            window.appendLog(`æ‰¾åˆ° ${result.folders.length} ä¸ªè®­ç»ƒæ•°æ®æ–‡ä»¶å¤¹\n`);
            window.appendLog(`ä½¿ç”¨å·¦å³æ–¹å‘é”®åˆ‡æ¢ï¼ŒæŒ‰Tæ ‡è®°ï¼Œè‡ªåŠ¨è·³è¿‡å·²æ ‡è®°\n`);

            // å¯åŠ¨ç¬¬ä¸€ä¸ªæœªæ ‡è®°çš„
            window.visualizeBrowseFolder(0, true); // å¯ç”¨è·³è¿‡å·²æ ‡è®°
        };

        // æ–°å¢ï¼šæ£€æŸ¥data.jsonæ˜¯å¦å·²æ ‡è®°ï¼ˆåŒ…æ‹¬æ­£ç¡®å’Œé”™è¯¯ï¼‰
        window.checkIfMarked = function(folderPath) {
            const fs = require('fs');
            const path = require('path');
            const dataJsonPath = path.join(folderPath, 'data.json');

            try {
                if (fs.existsSync(dataJsonPath)) {
                    const data = JSON.parse(fs.readFileSync(dataJsonPath, 'utf8'));
                    // æ–°æ ¼å¼ï¼šæ£€æŸ¥ review_status
                    if (data.review_status === 'approved' || data.review_status === 'rejected') {
                        return true;
                    }
                    // æ—§æ ¼å¼å…¼å®¹ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ ‡è®°ï¼ˆstates: true æˆ– error: trueï¼‰
                    if (data.states === true || data.error === true) {
                        return true;
                    }
                }
            } catch (err) {
                console.error('Failed to check mark:', err);
            }
            return false;
        };

        // æ–°å¢ï¼šæŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªæ ‡è®°çš„æ–‡ä»¶å¤¹
        window.findNextUnmarked = function(startIndex, direction) {
            if (!currentBrowseState) return -1;

            const total = currentBrowseState.folders.length;
            let index = startIndex;

            for (let i = 0; i < total; i++) {
                index += direction;

                // å¾ªç¯è¾¹ç•Œ
                if (index >= total) index = 0;
                if (index < 0) index = total - 1;

                const folder = currentBrowseState.folders[index];
                if (!window.checkIfMarked(folder.path)) {
                    return index;
                }
            }

            return -1; // æ‰€æœ‰éƒ½å·²æ ‡è®°
        };

        window.visualizeBrowseFolder = function(index, skipMarked = false) {
            if (!currentBrowseState || index < 0 || index >= currentBrowseState.folders.length) {
                return;
            }

            // å¦‚æœéœ€è¦è·³è¿‡å·²æ ‡è®°çš„ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªæ ‡è®°çš„
            if (skipMarked) {
                const folder = currentBrowseState.folders[index];
                if (window.checkIfMarked(folder.path)) {
                    window.appendLog(`[è·³è¿‡] ${folder.name} (å·²æ ‡è®°)\n`);
                    // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªæ ‡è®°çš„
                    const nextIndex = window.findNextUnmarked(index - 1, 1);
                    if (nextIndex === -1) {
                        window.appendLog('[æç¤º] æ‰€æœ‰æ•°æ®éƒ½å·²æ ‡è®°\n');
                        currentBrowseState = null;
                        return;
                    }
                    index = nextIndex;
                }
            }

            currentBrowseState.currentIndex = index;
            const folder = currentBrowseState.folders[index];

            window.appendLog(`\n>>> [${index + 1}/${currentBrowseState.folders.length}] æ’­æ”¾: ${folder.name}\n`);
            window.visualizeFolder(folder.path);
        };

        window.onload = async () => {
            console.log("Window loaded");
            const savedConfig = await ipcRenderer.invoke('load-config');
            if (savedConfig) {
                document.getElementById('demoDir').value = savedConfig.demoDir || '';
                if (savedConfig.demoDir) window.refreshDemoList(savedConfig.demoDir);

                document.getElementById('outputDir').value = savedConfig.outputDir || '';

                document.getElementById('steamId').value = savedConfig.playerSteamId || '';
                document.getElementById('speed').value = savedConfig.speed || '8';
                document.getElementById('framesPerWindow').value = savedConfig.framesPerWindow || '10';
                document.getElementById('dbPass').value = savedConfig.dbPass || '88683139';
            }

            // è‡ªåŠ¨åŠ è½½æ•°æ®åº“çŠ¶æ€
            window.refreshDatabaseStatus(true);

            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
            setTimeout(() => {
                window.toggleAutoRefresh();
            }, 1000); // å»¶è¿Ÿ1ç§’å¯åŠ¨ï¼Œé¿å…åˆå§‹åŒ–æ—¶çš„é‡å¤æŸ¥è¯¢

            // ç»‘å®šè‡ªåŠ¨åˆ·æ–°å¤é€‰æ¡†äº‹ä»¶
            document.getElementById('autoRefreshDb').addEventListener('change', window.toggleAutoRefresh);

            // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
            window.addEventListener('beforeunload', () => {
                if (dbAutoRefreshTimer) {
                    clearInterval(dbAutoRefreshTimer);
                    dbAutoRefreshTimer = null;
                }
            });
        };

        // åˆ·æ–°æ•°æ®åº“çŠ¶æ€
        window.refreshDatabaseStatus = async function(showButtonFeedback = false) {
            const dbPass = document.getElementById('dbPass').value;
            if (!dbPass) {
                return; // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºæç¤º
            }

            const btn = document.getElementById('refreshDbBtn');
            const originalText = btn.innerText;

            // åªæœ‰æ‰‹åŠ¨ç‚¹å‡»æ—¶æ‰æ˜¾ç¤ºæŒ‰é’®åé¦ˆ
            if (showButtonFeedback) {
                btn.innerText = 'â³';
                btn.disabled = true;
            }

            try {
                const status = await ipcRenderer.invoke('get-database-status', {
                    dbUser: 'postgres',
                    dbPass: dbPass
                });

                if (status.error) {
                    // è¿æ¥å¤±è´¥
                    document.getElementById('dbConnectionStatus').className = 'db-connection-status disconnected';
                    document.getElementById('dbDemosCount').innerText = '-';
                    document.getElementById('dbMatchesCount').innerText = '-';
                    document.getElementById('dbWindowsCount').innerText = '-';
                    document.getElementById('dbDemoList').innerHTML = `<div style="padding: 20px; color: #666; text-align: center; font-size: 11px;">è¿æ¥å¤±è´¥</div>`;
                } else {
                    // è¿æ¥æˆåŠŸ
                    let statusClass = 'db-connection-status connected';
                    // ä¿ç•™è‡ªåŠ¨åˆ·æ–°åŠ¨ç”»
                    if (document.getElementById('autoRefreshDb').checked) {
                        statusClass += ' auto-refresh';
                    }
                    document.getElementById('dbConnectionStatus').className = statusClass;

                    // æ›´æ–°ç»Ÿè®¡æ•°å­—
                    document.getElementById('dbDemosCount').innerText = status.demosCount || 0;
                    document.getElementById('dbMatchesCount').innerText = status.matchesCount || 0;
                    document.getElementById('dbWindowsCount').innerText = status.windowsCount || 0;

                    // æ›´æ–° Demo åˆ—è¡¨
                    const demoListEl = document.getElementById('dbDemoList');
                    if (status.demos && status.demos.length > 0) {
                        demoListEl.innerHTML = status.demos.map(demo => {
                            const shortChecksum = demo.checksum ? demo.checksum.substring(0, 16) + '...' : 'N/A';
                            const windowsCount = demo.windows_count || 0;
                            const windowsColor = windowsCount > 0 ? 'var(--primary)' : '#666';

                            return `
                                <div class="db-demo-item">
                                    <div class="db-demo-name">${demo.name || 'Unknown'}</div>
                                    <div class="db-demo-checksum">Checksum: ${shortChecksum}</div>
                                    <div class="db-demo-windows" style="color: ${windowsColor};">
                                        ğŸ“Š Training Windows: ${windowsCount}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        demoListEl.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">æš‚æ— æ•°æ®</div>';
                    }
                }
            } catch (err) {
                document.getElementById('dbConnectionStatus').className = 'db-connection-status disconnected';
                console.error('Failed to refresh database status:', err);
            } finally {
                if (showButtonFeedback) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        };

        // å¯åŠ¨/åœæ­¢è‡ªåŠ¨åˆ·æ–°
        window.toggleAutoRefresh = function() {
            const autoRefreshCheckbox = document.getElementById('autoRefreshDb');
            const statusIndicator = document.getElementById('dbConnectionStatus');

            if (autoRefreshCheckbox.checked) {
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                if (!dbAutoRefreshTimer) {
                    dbAutoRefreshTimer = setInterval(() => {
                        window.refreshDatabaseStatus();
                    }, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡

                    // æ·»åŠ è„‰å†²åŠ¨ç”»
                    statusIndicator.classList.add('auto-refresh');
                    console.log('[DB] Auto-refresh enabled (3s interval)');
                }
            } else {
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                if (dbAutoRefreshTimer) {
                    clearInterval(dbAutoRefreshTimer);
                    dbAutoRefreshTimer = null;

                    // ç§»é™¤è„‰å†²åŠ¨ç”»
                    statusIndicator.classList.remove('auto-refresh');
                    console.log('[DB] Auto-refresh disabled');
                }
            }
        };

        // æ–°å¢:é”®ç›˜ç›‘å¬ - å·¦å³æ–¹å‘é”®åˆ‡æ¢
        document.addEventListener('keydown', function(e) {
            if (!currentBrowseState) return;

            if (e.key === 'ArrowLeft') {
                // ä¸Šä¸€ä¸ª
                e.preventDefault();
                const newIndex = currentBrowseState.currentIndex - 1;
                if (newIndex >= 0) {
                    window.visualizeBrowseFolder(newIndex);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯ç¬¬ä¸€ä¸ª\n');
                }
            } else if (e.key === 'ArrowRight') {
                // ä¸‹ä¸€ä¸ª
                e.preventDefault();
                const newIndex = currentBrowseState.currentIndex + 1;
                if (newIndex < currentBrowseState.folders.length) {
                    window.visualizeBrowseFolder(newIndex);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯æœ€åä¸€ä¸ª\n');
                }
            }
        });

        ipcRenderer.on('process-log', (e, d) => window.appendLog(d));
        ipcRenderer.on('process-complete', (e, c) => {
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('startBtn').disabled = false;
            window.appendLog("\n>>> ä»»åŠ¡ç»“æŸã€‚");

            // è‡ªåŠ¨åˆ·æ–°æ•°æ®åº“çŠ¶æ€ï¼ˆé™é»˜ï¼‰
            setTimeout(() => window.refreshDatabaseStatus(), 500);
        });

        // æ–°å¢ï¼šç›‘å¬å•ä¸ªæ–‡ä»¶çŠ¶æ€æ›´æ–°
        ipcRenderer.on('file-status-update', (e, { file, status, players, rounds }) => {
            // Find item by path matches
            const items = document.querySelectorAll('.file-item');
            for (let item of items) {
                if (item.dataset.path === file) {
                    if (status) {
                        let statusHtml = status;
                        if (rounds) {
                            statusHtml += ` <span style="background:#333; color:var(--primary); padding:1px 5px; border-radius:3px; margin-left:5px; font-weight:bold;">${rounds} å›åˆ</span>`;
                        }
                        item.querySelector('.file-status').innerHTML = statusHtml;
                    }
                    if (players && players.length > 0) {
                        const playerEl = item.querySelector('.file-players');
                        playerEl.innerHTML = players.map(p => `<div onclick="window.copyToClipboard(this.innerText)">${p}</div>`).join('');
                        playerEl.classList.add('visible');
                    }
                    break;
                }
            }

            // äº‹ä»¶é©±åŠ¨ï¼šæ–‡ä»¶çŠ¶æ€æ›´æ–°æ—¶åˆ·æ–°æ•°æ®åº“ï¼ˆé™é»˜ï¼‰
            window.refreshDatabaseStatus();
        });

        // æ–°å¢ï¼šç›‘å¬å¯è§†åŒ–åˆ é™¤äº‹ä»¶
        ipcRenderer.on('visualization-deleted', () => {
            window.appendLog('[GUI] å·²åˆ é™¤å½“å‰æ•°æ®\n');

            // å¦‚æœåœ¨æµè§ˆæ¨¡å¼ä¸‹ï¼Œè‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ªï¼ˆè·³è¿‡å·²æ ‡è®°ï¼‰
            if (currentBrowseState) {
                const nextIndex = currentBrowseState.currentIndex + 1;
                if (nextIndex < currentBrowseState.folders.length) {
                    window.appendLog(`>>> è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ª\n`);
                    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©Pythonè¿›ç¨‹å®Œå…¨é€€å‡º
                    setTimeout(() => {
                        window.visualizeBrowseFolder(nextIndex, true); // å¯ç”¨è·³è¿‡å·²æ ‡è®°
                    }, 1000);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯æœ€åä¸€ä¸ªï¼Œæµè§ˆç»“æŸ\n');
                    currentBrowseState = null;
                }
            }
        });

        // æ–°å¢ï¼šç›‘å¬å¯è§†åŒ–æ ‡è®°äº‹ä»¶
        ipcRenderer.on('visualization-marked', () => {
            window.appendLog('[GUI] å·²æ ‡è®°å½“å‰æ•°æ®ä¸ºåˆæ ¼ (review_status: approved)\n');

            // è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ªæœªæ ‡è®°çš„
            if (currentBrowseState) {
                const nextIndex = currentBrowseState.currentIndex + 1;
                if (nextIndex < currentBrowseState.folders.length) {
                    setTimeout(() => {
                        window.visualizeBrowseFolder(nextIndex, true); // å¯ç”¨è·³è¿‡å·²æ ‡è®°
                    }, 500);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯æœ€åä¸€ä¸ªï¼Œæµè§ˆç»“æŸ\n');
                    currentBrowseState = null;
                }
            }
        });

        // æ–°å¢ï¼šç›‘å¬å¯è§†åŒ–é”™è¯¯æ ‡è®°äº‹ä»¶
        ipcRenderer.on('visualization-error-marked', () => {
            window.appendLog('[GUI] å·²æ ‡è®°å½“å‰æ•°æ®ä¸ºé”™è¯¯ (review_status: rejected)\n');

            // è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ªæœªæ ‡è®°çš„
            if (currentBrowseState) {
                const nextIndex = currentBrowseState.currentIndex + 1;
                if (nextIndex < currentBrowseState.folders.length) {
                    setTimeout(() => {
                        window.visualizeBrowseFolder(nextIndex, true); // å¯ç”¨è·³è¿‡å·²æ ‡è®°
                    }, 500);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯æœ€åä¸€ä¸ªï¼Œæµè§ˆç»“æŸ\n');
                    currentBrowseState = null;
                }
            }
        });

        // æ–°å¢ï¼šç›‘å¬å¯è§†åŒ–ä¸‹ä¸€ä¸ªäº‹ä»¶
        ipcRenderer.on('visualization-next', () => {
            if (currentBrowseState) {
                const nextIndex = currentBrowseState.currentIndex + 1;
                if (nextIndex < currentBrowseState.folders.length) {
                    setTimeout(() => {
                        window.visualizeBrowseFolder(nextIndex, true); // å¯ç”¨è·³è¿‡å·²æ ‡è®°
                    }, 500);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯æœ€åä¸€ä¸ª\n');
                }
            }
        });

        // æ–°å¢ï¼šç›‘å¬å¯è§†åŒ–ä¸Šä¸€ä¸ªäº‹ä»¶
        ipcRenderer.on('visualization-prev', () => {
            if (currentBrowseState) {
                const prevIndex = currentBrowseState.currentIndex - 1;
                if (prevIndex >= 0) {
                    setTimeout(() => {
                        window.visualizeBrowseFolder(prevIndex, true); // å¯ç”¨è·³è¿‡å·²æ ‡è®°
                    }, 500);
                } else {
                    window.appendLog('[æç¤º] å·²ç»æ˜¯ç¬¬ä¸€ä¸ª\n');
                }
            }
        });

    </script>
</body>
</html>